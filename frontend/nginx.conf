server {
    listen 80; # Nginx escucha peticiones en el puerto 80 (HTTP estándar)
    server_name localhost; # Nombre del servidor (localhost para desarrollo)
    
    # Evita que Nginx cambie el puerto en las redirecciones (mantiene el 18080 que usa el usuario)
    absolute_redirect off;
    port_in_redirect off;
    
    root /usr/share/nginx/html; # Carpeta raíz donde están los archivos
    index index.html index_session.html; # Archivos por defecto si no se especifica uno

    # Sirve archivos CSS, JS e imágenes directamente desde Nginx (sin pasar por el backend)
    location /static/ {
        alias /usr/share/nginx/html/static/; # Ruta física de los archivos estáticos
        try_files $uri =404; # Si el archivo no existe, devuelve error 404
    }

    # Sirve las páginas HTML directamente desde Nginx
    location /templates/ {
        alias /usr/share/nginx/html/templates/; # Ruta física de las plantillas HTML
        try_files $uri $uri/ =404; # Intenta servir el archivo o carpeta, si no existe devuelve 404
    }

    # Reenvía las peticiones de la API REST al backend (FastAPI en puerto 8000)
    location /api {
        proxy_pass http://backend:8000; # Envía la petición al contenedor "backend"
        proxy_set_header Host $host; # Mantiene el host original en la petición
        proxy_set_header X-Real-IP $remote_addr; # Envía la IP real del cliente
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; # Cadena de IPs si hay múltiples proxies
        proxy_set_header X-Forwarded-Proto $scheme; # Indica si la petición original era HTTP o HTTPS
        proxy_redirect off; # Evita que el backend haga redirecciones automáticas
    }

    # Reenvía las rutas de navegación (páginas dinámicas) al backend
    location /home {
        proxy_pass http://backend:8000; # Envía al backend
        proxy_set_header Host $host; # Mantiene el host original
        proxy_set_header X-Real-IP $remote_addr; # IP real del cliente
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; # Cadena de proxies
        proxy_set_header X-Forwarded-Proto $scheme; # Protocolo original (HTTP/HTTPS)
        proxy_redirect off; # Sin redirecciones automáticas
    }

    # Documentación interactiva de la API (Swagger UI)
    location /docs {
        proxy_pass http://backend:8000/docs; # Reenvía al endpoint de documentación
        proxy_set_header Host $host; # Mantiene el host
    }

    # Esquema OpenAPI de la API (JSON con definición de endpoints)
    location /openapi.json {
        proxy_pass http://backend:8000/openapi.json; # Reenvía al esquema JSON
        proxy_set_header Host $host; # Mantiene el host
    }

    # Cuando entras a la raíz (http://localhost:18080/) muestra la página de login
    location = / {
        try_files /templates/index_session.html /index.html =404; # Intenta servir el login, si no existe devuelve 404
    }

    # Para cualquier otra ruta, intenta servir un archivo estático primero
    location / {
        try_files $uri $uri/ @backend; # Si no encuentra el archivo, envía al backend
    }

    # Fallback: Si no se encontró archivo estático, pregunta al backend
    location @backend {
        proxy_pass http://backend:8000; # Reenvía al backend
        proxy_set_header Host $host; # Mantiene el host
        proxy_set_header X-Real-IP $remote_addr; # IP real del cliente
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; # Cadena de proxies
        proxy_set_header X-Forwarded-Proto $scheme; # Protocolo original
        proxy_redirect off; # Sin redirecciones automáticas
    }
}
