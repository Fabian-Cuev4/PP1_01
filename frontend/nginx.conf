# EXPLICACIÓN: Configuración de Load Balancer para alta disponibilidad
# NOTA: Este archivo se carga como default.conf en nginx

# EXPLICACIÓN: Load Balancer para APIs
# - Distribuye carga entre 2 servidores API
# - least_conn: envía a quien tenga menos conexiones
split_clients "${remote_addr}${request_id}" $new_srv {
    50% "s1";
    *   "s2";
}

map $cookie_SRV $srv_route {
    default $cookie_SRV;
    ""      $new_srv;
}

upstream api_backend {
    hash $srv_route consistent;
    server api_back_1:8000 weight=1 max_fails=3 fail_timeout=30s;
    server api_back_2:8000 weight=1 max_fails=3 fail_timeout=30s;
}

# EXPLICACIÓN: Servidor principal en puerto 81 - Punto de entrada único
server {
    listen 81;
    server_name localhost;
    
    absolute_redirect off;
    port_in_redirect off;
    root /usr/share/nginx/html;

    # Sirve archivos estáticos (CSS, JS, imágenes)
    location /static/ {
        try_files $uri =404;
        access_log off;
        expires 1d;
        add_header Cache-Control "public, immutable";
    }

    # NO cachear archivos JavaScript - siempre pedir versión nueva
    location ~ \.js$ {
        try_files $uri =404;
        add_header Cache-Control "no-cache, no-store, must-revalidate";
        add_header Pragma "no-cache";
        add_header Expires "0";
    }

    # EXPLICACIÓN: API Load Balancer - Distribuye peticiones entre los 2 servidores
    # Todas las peticiones /api/* se distribuyen automáticamente
    location /api/ {
        add_header Set-Cookie "SRV=$srv_route; Max-Age=300; Path=/; HttpOnly; SameSite=Lax" always;
        proxy_pass http://api_backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $server_name;
        proxy_set_header X-Forwarded-Port $server_port;
        proxy_redirect off;
        
        # EXPLICACIÓN: Health check y timeouts
        # Si un servidor falla, Nginx automáticamente dejará de enviarle tráfico
        proxy_connect_timeout 5s;
        proxy_send_timeout 10s;
        proxy_read_timeout 10s;

        # EXPLICACIÓN: límite de conexiones simultáneas por backend (1 por servidor)
        # Si ambos están ocupados, Nginx devolverá 503.
        proxy_next_upstream error timeout http_502 http_503 http_504;
    }

    location = /sticky/logout {
        add_header Set-Cookie "SRV=deleted; Max-Age=0; Expires=Thu, 01 Jan 1970 00:00:00 GMT; Path=/; HttpOnly; SameSite=Lax" always;
        return 204;
    }

    # Documentación de la API (también con load balancing)
    location /docs {
        proxy_pass http://api_backend/docs;
        proxy_set_header Host $host;
    }

    location /openapi.json {
        proxy_pass http://api_backend/openapi.json;
        proxy_set_header Host $host;
    }

    # EXPLICACIÓN: Proxy directo a cada API (sirve para UP/DOWN real desde el dashboard)
    location /api1/ {
        proxy_pass http://api_back_1:8000/;
        proxy_set_header Host $host;
    }

    location /api2/ {
        proxy_pass http://api_back_2:8000/;
        proxy_set_header Host $host;
    }

    # Rutas de páginas - Orden importante: más específicas primero
    location ~ ^/pagina/maquinas/historial {
        rewrite ^/pagina/maquinas/historial$ /templates/index_historial.html break;
        try_files $uri @not_found;
    }

    location ~ ^/pagina/maquinas/reportes {
        rewrite ^/pagina/maquinas/reportes$ /templates/index_ventana3.html break;
        try_files $uri @not_found;
    }

    location ~ ^/pagina/maquinas/mantenimiento {
        rewrite ^/pagina/maquinas/mantenimiento$ /templates/index_formulario2.html break;
        try_files $uri @not_found;
    }

    location ~ ^/pagina/maquinas/actualizar {
        rewrite ^/pagina/maquinas/actualizar$ /templates/index_actualizar.html break;
        try_files $uri @not_found;
    }

    location ~ ^/pagina/maquinas/agregar {
        rewrite ^/pagina/maquinas/agregar$ /templates/index_formulario1.html break;
        try_files $uri @not_found;
    }

    location ~ ^/pagina/maquinas {
        rewrite ^/pagina/maquinas$ /templates/index_ventana2.html break;
        try_files $uri @not_found;
    }

    location ~ ^/pagina/inicio {
        rewrite ^/pagina/inicio$ /templates/index_ventana1.html break;
        try_files $uri @not_found;
    }

    location ~ ^/pagina/dashboard {
        rewrite ^/pagina/dashboard$ /templates/index_dashboard.html break;
        try_files $uri @not_found;
    }

    location ~ ^/pagina/registro {
        rewrite ^/pagina/registro$ /templates/index_register.html break;
        try_files $uri @not_found;
    }

    location ~ ^/pagina/login {
        rewrite ^/pagina/login$ /templates/index_session.html break;
        try_files $uri @not_found;
    }

    # Raíz redirige a login (rewrite interno)
    location = / {
        rewrite ^$ /pagina/login break;
    }

    # Manejo de errores 404
    location @not_found {
        return 404;
    }

    # Cualquier otra ruta retorna 404
    location / {
        return 404;
    }
}

# EXPLICACIÓN: Dashboard simple de monitoreo (Puerto 8083)
server {
    listen 8083;
    server_name localhost;
    
    absolute_redirect off;
    port_in_redirect off;
    root /usr/share/nginx/html;

    # Sirve archivos estáticos del dashboard (JS/CSS/img)
    location /static/ {
        try_files $uri =404;
        access_log off;
        expires 1d;
        add_header Cache-Control "public, immutable";
    }

    # EXPLICACIÓN: Proxy directo a cada API (sirve para UP/DOWN real sin CORS)
    location /api1/ {
        proxy_pass http://api_back_1:8000/;
        proxy_set_header Host $host;
        proxy_connect_timeout 500ms;
        proxy_send_timeout 1s;
        proxy_read_timeout 1s;
    }

    location /api2/ {
        proxy_pass http://api_back_2:8000/;
        proxy_set_header Host $host;
        proxy_connect_timeout 500ms;
        proxy_send_timeout 1s;
        proxy_read_timeout 1s;
    }

    # Dashboard (HTML)
    location = / {
        try_files /templates/index_dashboard.html =404;
    }

    location = /dashboard {
        try_files /templates/index_dashboard.html =404;
    }

    location /templates/ {
        try_files $uri =404;
    }
}
