# HAProxy Configuration - Load Balance con 3 Servidores (Versión Simplificada)
global
    daemon
    maxconn 4096
    
defaults
    mode http
    timeout connect 5000ms
    timeout client 50000ms
    timeout server 50000ms
    option httplog
    option log-health-checks
    option dontlognull
    option http-server-close
    option forwardfor

# Frontend - Recibe peticiones de los usuarios
frontend api_frontend
    bind *:81
    default_backend api_servers
    option httplog
    maxconn 1000

# Backend - Distribuye carga entre 3 servidores
backend api_servers
    balance roundrobin
    option httpchk GET /api/maquinas/listar
    fullconn 1000
    
    # 3 Servidores backend con tracking de sesiones
    server backend1 backend-1:8000 check inter 5s rise 2 fall 3 maxconn 500
    server backend2 backend-2:8000 check inter 5s rise 2 fall 3 maxconn 500
    server backend3 backend-3:8000 check inter 5s rise 2 fall 3 maxconn 500
    
    # Headers para saber qué servidor atendió
    http-response set-header X-Backend-Server %[srv_name]

# Dashboard de HAProxy - Para ver estadísticas
listen stats
    bind *:8404
    stats enable
    stats uri /stats
    stats refresh 3s
    stats show-desc Load Balance SIGLAB
    stats show-legends
    stats admin if TRUE
    stats hide-version
