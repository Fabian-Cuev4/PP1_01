services:
  # SERVICIO 1: Base de datos MySQL
  mysql:
    image: mysql:8.0 # Imagen oficial MySQL 8.0
    container_name: mysql_siglab # Nombre del contenedor
    restart: always # Reinicio automático
    environment:
      # Variables de entorno MySQL
      MYSQL_ROOT_PASSWORD: Clubpengui1 # Contraseña root
      MYSQL_DATABASE: proyecto_maquinas # Base de datos automática
    ports:
      - "13306:3306" # Mapeo puerto 13306 -> 3306
    volumes:
      - mysql_data:/var/lib/mysql # Persistencia de datos
    networks:
      - siglab_network # Red interna
    healthcheck:
      # Verificación de salud MySQL
      test: [ "CMD-SHELL", "mysqladmin ping -h localhost -u root -pClubpengui1 || exit 1" ]
      interval: 30s # Verificación cada 30s
      timeout: 10s # Timeout 10s
      retries: 5 # 5 reintentos
      start_period: 40s # Periodo de gracia 40s

  # SERVICIO 2: Base de datos MongoDB
  mongodb:
    image: mongo:latest # Imagen oficial MongoDB
    container_name: mongo_siglab # Nombre del contenedor
    restart: always # Reinicio automático
    ports:
      - "27018:27017" # Mapeo puerto 27018 -> 27017
    volumes:
      - mongo_data:/data/db # Persistencia MongoDB
    networks:
      - siglab_network # Red interna
    healthcheck:
      # Verificación de salud MongoDB
      test: [ "CMD-SHELL", "mongosh --eval \"db.adminCommand('ping')\" --quiet || exit 1" ]
      interval: 30s # Verificación cada 30s
      timeout: 10s # Timeout 10s
      retries: 3 # 3 reintentos
      start_period: 15s # Periodo de gracia 15s

  # SERVICIO 3: Backend con Réplicas (FastAPI) - Escalable para máquinas
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    restart: always
    environment:
      MYSQL_HOST: mysql
      MYSQL_USER: root
      MYSQL_PASSWORD: Clubpengui1
      MYSQL_DATABASE: proyecto_maquinas
      MONGO_HOST: mongodb
      MONGO_PORT: 27017
      SERVER_ID: ${HOSTNAME:-backend}  # ID único por contenedor para dashboard
    volumes:
      - ./backend:/app
    depends_on:
      mysql:
        condition: service_healthy
      mongodb:
        condition: service_healthy
      kafka:
        condition: service_healthy
    networks:
      - siglab_network
    deploy:
      replicas: 3  # 3 réplicas para balanceo de máquinas
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M
    profiles:
      - all  # Perfil completo con todo menos k6

  # SERVICIO 3.1: Backend Único (para desarrollo sin balanceo)
  backend-simple:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: backend_siglab_simple
    restart: always
    environment:
      MYSQL_HOST: mysql
      MYSQL_USER: root
      MYSQL_PASSWORD: Clubpengui1
      MYSQL_DATABASE: proyecto_maquinas
      MONGO_HOST: mongodb
      MONGO_PORT: 27017
      SERVER_ID: 0  # Servidor único
    ports:
      - "18000:8000"  # Backend simple para desarrollo
    volumes:
      - ./backend:/app
    depends_on:
      mysql:
        condition: service_healthy
      mongodb:
        condition: service_healthy
    networks:
      - siglab_network
      - frontend_network  # Red exclusiva para frontend
    profiles:
      - all  # Todo junto

  # SERVICIO 4: Balanceador de Carga Nginx (SOLO para microservicio máquinas)
  nginx:
    build:
      context: ./nginx
      dockerfile: Dockerfile
    container_name: nginx_balancer
    restart: always
    ports:
      - "8888:80"      # Balanceador principal para máquinas (cambiado de 80)
      - "8080:8080"   # Monitoreo de estado
    networks:
      - siglab_network
      - frontend_network  # Para comunicación con frontend
    profiles:
      - all  # Solo en perfil completo

  # SERVICIO 5: Frontend
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: frontend_siglab
    restart: always
    ports:
      - "18080:5173"  # Vite dev server puerto 5173
    volumes:
      # Montar código para desarrollo en caliente
      - ./frontend:/app
      - /app/node_modules  # Evitar sobreescribir node_modules
    depends_on:
      - backend-simple  # Solo backend simple
    networks:
      - frontend_network  # Red exclusiva con backend-simple
    profiles:
      - all  # Todo junto

  # SERVICIO 6: Apache Kafka - Mensajería asíncrona (configuración simplificada)
  kafka:
    image: wurstmeister/kafka:latest
    container_name: kafka_siglab
    restart: always
    environment:
      KAFKA_ADVERTISED_HOST_NAME: kafka
      KAFKA_ADVERTISED_PORT: 9092
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_CREATE_TOPICS: "load-balancer-events:1:1"
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: 'true'
    ports:
      - "9092:9092"
    depends_on:
      - zookeeper
    networks:
      - siglab_network
    healthcheck:
      test: ["CMD", "nc", "-z", "localhost", "9092"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    profiles:
      - all

  # SERVICIO 6.1: Zookeeper requerido por Kafka
  zookeeper:
    image: zookeeper:latest
    container_name: zookeeper_siglab
    restart: always
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    networks:
      - siglab_network
    healthcheck:
      test: ["CMD", "nc", "-z", "localhost", "2181"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s
    profiles:
      - all

  # SERVICIO 6.2: Kafka UI - Interfaz gráfica para monitoreo
  kafka-ui:
    image: provectuslabs/kafka-ui:latest
    container_name: kafka_ui_siglab
    restart: always
    environment:
      KAFKA_CLUSTERS_0_NAME: local
      KAFKA_CLUSTERS_0_BOOTSTRAPSERVERS: kafka:9092
      KAFKA_CLUSTERS_0_ZOOKEEPER: zookeeper:2181
    ports:
      - "18090:8080"
    depends_on:
      kafka:
        condition: service_healthy
    networks:
      - siglab_network
    profiles:
      - all

  # SERVICIO 7: Dashboard Load Balancer - Visualización en tiempo real
  dashboard:
    build:
      context: ./dashboard
      dockerfile: Dockerfile
    container_name: dashboard_siglab
    restart: always
    ports:
      - "18081:3000"  # Dashboard en puerto 18081
    environment:
      KAFKA_BROKER: kafka:9092
      NGINX_STATS_URL: http://nginx:8080/nginx_status
    depends_on:
      - kafka
      - nginx
    networks:
      - siglab_network
    profiles:
      - all

# SERVICIO 8: Saturador k6 para pruebas de carga
  k6-saturator:
    build:
      context: ./k6
      dockerfile: Dockerfile
    container_name: k6_saturator
    environment:
      BASE_URL: http://nginx:80  # URL corregida del servicio nginx
    networks:
      - siglab_network  # Solo red siglab_network para comunicación con nginx
    profiles:
      - load-test  # Solo k6 (asume que el resto ya corre)

# VOLÚMENES - Almacenamiento Persistente
volumes:
  mysql_data:
    # Volumen datos MySQL
    driver: local # Almacenamiento local
  mongo_data:
    # Volumen datos MongoDB
    driver: local # Almacenamiento local

# REDES - Comunicación entre Contenedores
networks:
  siglab_network:
    # Red interna principal
    driver: bridge # Red virtual privada
  
  frontend_network:
    # Red exclusiva frontend
    driver: bridge
