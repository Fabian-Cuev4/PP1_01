services:
  # SERVICIO 1: Base de datos MySQL
  mysql:
    image: mysql:8.0 # Usa la imagen oficial de MySQL versión 8.0
    container_name: mysql_siglab # Nombre del contenedor para identificarlo fácilmente
    restart: always # Si el contenedor se cae, Docker lo reinicia automáticamente
    environment:
      # Variables de entorno para configurar MySQL
      MYSQL_ROOT_PASSWORD: Clubpengui1 # Contraseña del usuario root
      MYSQL_DATABASE: proyecto_maquinas # Crea automáticamente esta base de datos al iniciar
    ports:
      - "13306:3306" # Mapea puerto 13306 de tu PC al puerto 3306 del contenedor (evita conflictos)
    volumes:
      - mysql_data:/var/lib/mysql # Guarda los datos en un volumen para que persistan al reiniciar
    networks:
      - siglab_network # Conecta este contenedor a la red interna para comunicarse con otros
    healthcheck:
      # Verifica que MySQL esté funcionando correctamente
      test: [ "CMD-SHELL", "mysqladmin ping -h localhost -u root -pClubpengui1 || exit 1" ] # Comando para verificar salud
      interval: 30s # Verifica cada 30 segundos
      timeout: 10s # Espera máximo 10 segundos por respuesta
      retries: 5 # Intenta 5 veces antes de marcar como "unhealthy"
      start_period: 40s # Da 40 segundos de gracia antes de empezar a verificar (MySQL tarda en iniciar)

  # SERVICIO 2: Base de datos MongoDB
  mongodb:
    image: mongo:latest # Usa la imagen oficial de MongoDB (última versión)
    container_name: mongo_siglab # Nombre del contenedor
    restart: always # Reinicio automático si falla
    ports:
      - "27018:27017" # Mapea puerto 27018 de tu PC al puerto 27017 del contenedor
    volumes:
      - mongo_data:/data/db # Guarda los datos de MongoDB en un volumen persistente
    networks:
      - siglab_network # Conecta a la red interna
    healthcheck:
      # Verifica que MongoDB esté funcionando
      test: [ "CMD-SHELL", "mongosh --eval \"db.adminCommand('ping')\" --quiet || exit 1" ] # Comando de verificación
      interval: 30s # Verifica cada 30 segundos
      timeout: 10s # Espera máximo 10 segundos
      retries: 3 # Intenta 3 veces antes de marcar como "unhealthy"
      start_period: 15s # Da 15 segundos de gracia (MongoDB inicia más rápido que MySQL)

  # SERVICIO 3: Backend con Réplicas (FastAPI) - Escalable para máquinas
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    restart: always
    environment:
      MYSQL_HOST: mysql
      MYSQL_USER: root
      MYSQL_PASSWORD: Clubpengui1
      MYSQL_DATABASE: proyecto_maquinas
      MONGO_HOST: mongodb
      MONGO_PORT: 27017
      SERVER_ID: ${HOSTNAME:-backend}  # ID único por contenedor para dashboard
    volumes:
      - ./backend:/app
    depends_on:
      mysql:
        condition: service_healthy
      mongodb:
        condition: service_healthy
    networks:
      - siglab_network
      - frontend_network  # Para comunicación con nginx
    deploy:
      replicas: 3  # 3 réplicas para balanceo de máquinas
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M
    profiles:
      - all  # Perfil completo con todo menos k6

  # SERVICIO 3.1: Backend Único (para desarrollo sin balanceo)
  backend-simple:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: backend_siglab_simple
    restart: always
    environment:
      MYSQL_HOST: mysql
      MYSQL_USER: root
      MYSQL_PASSWORD: Clubpengui1
      MYSQL_DATABASE: proyecto_maquinas
      MONGO_HOST: mongodb
      MONGO_PORT: 27017
      SERVER_ID: 0  # Servidor único
    ports:
      - "18000:8000"  # Backend simple para desarrollo
    volumes:
      - ./backend:/app
    depends_on:
      mysql:
        condition: service_healthy
      mongodb:
        condition: service_healthy
    networks:
      - siglab_network
      - frontend_network  # Red exclusiva para frontend
    profiles:
      - all  # Todo junto

  # SERVICIO 4: Balanceador de Carga Nginx (SOLO para microservicio máquinas)
  nginx:
    build:
      context: ./nginx
      dockerfile: Dockerfile
    container_name: nginx_balancer
    restart: always
    ports:
      - "8888:80"      # Balanceador principal para máquinas (cambiado de 80)
      - "8080:8080"   # Monitoreo de estado
    networks:
      - siglab_network
      - frontend_network  # Para comunicación con frontend
    profiles:
      - all  # Solo en perfil completo

  # SERVICIO 5: Frontend
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: frontend_siglab
    restart: always
    ports:
      - "18080:5173"  # Vite dev server puerto 5173
    volumes:
      # Montar código para desarrollo en caliente
      - ./frontend:/app
      - /app/node_modules  # Evitar sobreescribir node_modules
    depends_on:
      - backend-simple  # Solo backend simple
    networks:
      - frontend_network  # Red exclusiva con backend-simple
    profiles:
      - all  # Todo junto

# SERVICIO 6: Saturador k6 para pruebas de carga
  k6-saturator:
    build:
      context: ./k6
      dockerfile: Dockerfile
    container_name: k6_saturator
    environment:
      BASE_URL: http://nginx_balancer:80  # URL de nginx para máquinas
    networks:
      - siglab_network
      - frontend_network  # Para comunicación con nginx
    profiles:
      - load-test  # Solo k6 (asume que el resto ya corre)

# VOLÚMENES (Almacenamiento Persistente)
volumes:
  mysql_data:
    # Volumen para guardar datos de MySQL
    driver: local # Almacena en el disco local de tu PC
  mongo_data:
    # Volumen para guardar datos de MongoDB
    driver: local # Almacena en el disco local de tu PC

# REDES (Comunicación entre Contenedores)
networks:
  siglab_network:
    # Red interna para que los contenedores se comuniquen entre sí
    driver: bridge # Tipo de red: bridge (red virtual privada)
  
  frontend_network:
    # Red exclusiva para frontend y backend-simple
    driver: bridge
