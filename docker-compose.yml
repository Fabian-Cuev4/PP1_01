
services:
  # MySQL Database
  mysql:
    image: mysql:8.0
    container_name: mysql_siglab
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: Clubpengui1
      MYSQL_DATABASE: proyecto_maquinas
    ports:
      - "13306:3306"
    volumes:
      - mysql_data:/var/lib/mysql
    networks:
      - load_balance_network
    healthcheck:
      test: ["CMD-SHELL", "mysqladmin ping -h localhost -u root -pClubpengui1 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 40s

  # MongoDB Database
  mongodb:
    image: mongo:latest
    container_name: mongo_siglab
    restart: always
    ports:
      - "27018:27017"
    volumes:
      - mongo_data:/data/db
    networks:
      - load_balance_network
    healthcheck:
      test: ["CMD-SHELL", "mongosh --eval \"db.adminCommand('ping')\" --quiet || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s

  # HAProxy - Load Balance Principal
  haproxy-lb:
    image: haproxy:2.8-alpine
    container_name: haproxy_lb
    restart: always
    ports:
      - "81:81"        # Load Balancer principal (CORREGIDO)
      - "8404:8404"    # HAProxy Stats Dashboard (¡EL MÁS IMPORTANTE!)
    volumes:
      - ./haproxy/haproxy.cfg:/usr/local/etc/haproxy/haproxy.cfg:ro
    depends_on:
      - backend-1
      - backend-2
      - backend-3
    networks:
      - load_balance_network
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:8404/stats"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Backend 1 - FastAPI Instance
  backend-1:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: backend_siglab_1
    restart: always
    environment:
      MYSQL_HOST: mysql
      MYSQL_USER: root
      MYSQL_PASSWORD: Clubpengui1
      MYSQL_DATABASE: proyecto_maquinas
      MONGO_HOST: mongodb
      MONGO_PORT: 27017
      INSTANCE_ID: "backend-1"
      SERVER_NAME: "Backend-Server-1"
    volumes:
      - ./backend:/app
    depends_on:
      mysql:
        condition: service_healthy
      mongodb:
        condition: service_healthy
    networks:
      - load_balance_network
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:8000/docs"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Backend 2 - FastAPI Instance
  backend-2:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: backend_siglab_2
    restart: always
    environment:
      MYSQL_HOST: mysql
      MYSQL_USER: root
      MYSQL_PASSWORD: Clubpengui1
      MYSQL_DATABASE: proyecto_maquinas
      MONGO_HOST: mongodb
      MONGO_PORT: 27017
      INSTANCE_ID: "backend-2"
      SERVER_NAME: "Backend-Server-2"
    volumes:
      - ./backend:/app
    depends_on:
      mysql:
        condition: service_healthy
      mongodb:
        condition: service_healthy
    networks:
      - load_balance_network
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:8000/docs"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Backend 3 - FastAPI Instance (NUEVO)
  backend-3:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: backend_siglab_3
    restart: always
    environment:
      MYSQL_HOST: mysql
      MYSQL_USER: root
      MYSQL_PASSWORD: Clubpengui1
      MYSQL_DATABASE: proyecto_maquinas
      MONGO_HOST: mongodb
      MONGO_PORT: 27017
      INSTANCE_ID: "backend-3"
      SERVER_NAME: "Backend-Server-3"
    volumes:
      - ./backend:/app
    depends_on:
      mysql:
        condition: service_healthy
      mongodb:
        condition: service_healthy
    networks:
      - load_balance_network
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:8000/docs"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Frontend - Nginx
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: frontend_siglab
    restart: always
    ports:
      - "8080:80"  # Puerto separado para frontend
    volumes:
      - ./frontend/static:/usr/share/nginx/html/static
      - ./frontend/templates:/usr/share/nginx/html/templates
      - ./frontend/nginx.conf:/etc/nginx/conf.d/default.conf:ro
    depends_on:
      - haproxy-lb
    networks:
      - load_balance_network

volumes:
  mysql_data:
    driver: local
  mongo_data:
    driver: local

networks:
  load_balance_network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.22.0.0/16
