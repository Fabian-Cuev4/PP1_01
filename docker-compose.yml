services:
  # SERVICIO 1: Base de datos MySQL - Archivador Central Compartido
  mysql:
    image: mysql:8.0
    container_name: mysql_siglab
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: Clubpengui1
      MYSQL_DATABASE: proyecto_maquinas
    ports:
      - "13306:3306"
    volumes:
      - mysql_data:/var/lib/mysql
    networks:
      - siglab_network
    healthcheck:
      test: [ "CMD-SHELL", "mysqladmin ping -h localhost -u root -pClubpengui1 || exit 1" ]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 40s

  # SERVICIO 2: Base de datos MongoDB - Archivador Central Compartido
  mongodb:
    image: mongo:latest
    container_name: mongo_siglab
    restart: always
    ports:
      - "27018:27017"
    volumes:
      - mongo_data:/data/db
    networks:
      - siglab_network
    healthcheck:
      test: [ "CMD-SHELL", "mongosh --eval \"db.adminCommand('ping')\" --quiet || exit 1" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s

  # SERVICIO 3: API Backend 1 - Primera instancia del servidor de API
  api_back_1:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: api_back_1
    restart: always
    environment:
      # EXPLICACIÓN: Conexión a bases de datos compartidas usando nombres de servicio Docker
      MYSQL_HOST: mysql
      MYSQL_USER: root
      MYSQL_PASSWORD: Clubpengui1
      MYSQL_DATABASE: proyecto_maquinas
      MONGO_HOST: mongodb
      MONGO_PORT: 27017
      # EXPLICACIÓN: Identificador único para logs
      API_SERVER_ID: "API Servidor 1"
    ports:
      - "18001:8000"
    volumes:
      - ./backend:/app
    depends_on:
      mysql:
        condition: service_healthy
      mongodb:
        condition: service_healthy
    networks:
      - siglab_network

  # SERVICIO 4: API Backend 2 - Segunda instancia del servidor de API
  api_back_2:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: api_back_2
    restart: always
    environment:
      # EXPLICACIÓN: Conexión a las MISMAS bases de datos que api_back_1
      MYSQL_HOST: mysql
      MYSQL_USER: root
      MYSQL_PASSWORD: Clubpengui1
      MYSQL_DATABASE: proyecto_maquinas
      MONGO_HOST: mongodb
      MONGO_PORT: 27017
      # EXPLICACIÓN: Identificador único para logs
      API_SERVER_ID: "API Servidor 2"
    ports:
      - "18002:8000"
    volumes:
      - ./backend:/app
    depends_on:
      mysql:
        condition: service_healthy
      mongodb:
        condition: service_healthy
    networks:
      - siglab_network

  # SERVICIO 5: Nginx Load Balancer - Punto Único de Entrada
  nginx_balancer:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: nginx_balancer_siglab
    restart: always
    ports:
      - "8080:81"      # Puerto principal para usuarios (Frontend + Load Balancer)
      - "8084:8083"   # Dashboard de monitoreo VTS
    volumes:
      - ./frontend/static:/usr/share/nginx/html/static
      - ./frontend/templates:/usr/share/nginx/html/templates
      - ./frontend/nginx.conf:/etc/nginx/conf.d/default.conf:ro
    depends_on:
      - api_back_1
      - api_back_2
    networks:
      - siglab_network

# VOLÚMENES (Almacenamiento Persistente)
volumes:
  mysql_data:
    # Volumen para guardar datos de MySQL
    driver: local # Almacena en el disco local de tu PC
  mongo_data:
    # Volumen para guardar datos de MongoDB
    driver: local # Almacena en el disco local de tu PC

# REDES (Comunicación entre Contenedores)
networks:
  siglab_network:
    # Red interna para que los contenedores se comuniquen entre sí
    driver: bridge # Tipo de red: bridge (red virtual privada)
