services:
  # SERVICIO 1: Base de datos MySQL
  mysql:
    image: mysql:8.0 # Usa la imagen oficial de MySQL versión 8.0
    container_name: mysql_siglab # Nombre del contenedor para identificarlo fácilmente
    restart: always # Si el contenedor se cae, Docker lo reinicia automáticamente
    environment:
      # Variables de entorno para configurar MySQL
      MYSQL_ROOT_PASSWORD: Clubpengui1 # Contraseña del usuario root
      MYSQL_DATABASE: proyecto_maquinas # Crea automáticamente esta base de datos al iniciar
    ports:
      - "13306:3306" # Mapea puerto 13306 de tu PC al puerto 3306 del contenedor (evita conflictos)
    volumes:
      - mysql_data:/var/lib/mysql # Guarda los datos en un volumen para que persistan al reiniciar
    networks:
      - siglab_network # Conecta este contenedor a la red interna para comunicarse con otros
    healthcheck:
      # Verifica que MySQL esté funcionando correctamente
      test: [ "CMD-SHELL", "mysqladmin ping -h localhost -u root -pClubpengui1 || exit 1" ] # Comando para verificar salud
      interval: 30s # Verifica cada 30 segundos
      timeout: 10s # Espera máximo 10 segundos por respuesta
      retries: 5 # Intenta 5 veces antes de marcar como "unhealthy"
      start_period: 40s # Da 40 segundos de gracia antes de empezar a verificar (MySQL tarda en iniciar)

  # SERVICIO 2: Base de datos MongoDB
  mongodb:
    image: mongo:latest # Usa la imagen oficial de MongoDB (última versión)
    container_name: mongo_siglab # Nombre del contenedor
    restart: always # Reinicio automático si falla
    ports:
      - "27018:27017" # Mapea puerto 27018 de tu PC al puerto 27017 del contenedor
    volumes:
      - mongo_data:/data/db # Guarda los datos de MongoDB en un volumen persistente
    networks:
      - siglab_network # Conecta a la red interna
    healthcheck:
      # Verifica que MongoDB esté funcionando
      test: [ "CMD-SHELL", "mongosh --eval \"db.adminCommand('ping')\" --quiet || exit 1" ] # Comando de verificación
      interval: 30s # Verifica cada 30 segundos
      timeout: 10s # Espera máximo 10 segundos
      retries: 3 # Intenta 3 veces antes de marcar como "unhealthy"
      start_period: 15s # Da 15 segundos de gracia (MongoDB inicia más rápido que MySQL)

  # SERVICIO 3: Backend (FastAPI)
  backend:
    build:
      # En lugar de usar una imagen pre-hecha, construye una personalizada
      context: ./backend # Carpeta donde está el código del backend
      dockerfile: Dockerfile # Archivo con instrucciones para construir la imagen
    container_name: backend_siglab # Nombre del contenedor
    restart: always # Reinicio automático
    environment:
      # Variables de entorno que el backend necesita para conectarse a las bases de datos
      MYSQL_HOST: mysql # Nombre del servicio MySQL (Docker resuelve esto como IP interna)
      MYSQL_USER: root # Usuario de MySQL
      MYSQL_PASSWORD: Clubpengui1 # Contraseña de MySQL
      MYSQL_DATABASE: proyecto_maquinas # Base de datos a usar
      MONGO_HOST: mongodb # Nombre del servicio MongoDB
      MONGO_PORT: 27017 # Puerto interno de MongoDB
    ports:
      - "18000:8000" # Mapea puerto 18000 de tu PC al puerto 8000 del contenedor (FastAPI)
    volumes:
      # Monta carpetas de tu PC dentro del contenedor (cambios en vivo)
      - ./backend:/app # Carpeta del backend se sincroniza con /app en el contenedor
    depends_on:
      # Este contenedor solo inicia cuando MySQL y MongoDB estén "healthy"
      mysql:
        condition: service_healthy # Espera a que MySQL pase el healthcheck
      mongodb:
        condition: service_healthy # Espera a que MongoDB pase el healthcheck
    networks:
      - siglab_network # Conecta a la red interna

  # SERVICIO 4: Frontend (React + Vite)
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: frontend_siglab
    restart: always
    ports:
      - "18080:5173"  # Vite dev server puerto 5173
    volumes:
      # Montar código para desarrollo en caliente
      - ./frontend:/app
      - /app/node_modules  # Evitar sobreescribir node_modules
    depends_on:
      - backend
    networks:
      - siglab_network

# SERVICIO 5: Saturador k6 para pruebas de carga
  k6-saturator:
    build:
      context: ./k6
      dockerfile: Dockerfile
    container_name: k6_saturator
    environment:
      BASE_URL: http://host.docker.internal:18000  # URL del backend desde el contenedor k6
    depends_on:
      - backend
    networks:
      - siglab_network
    profiles:
      - load-test  # Solo se inicia con --profile load-test

# VOLÚMENES (Almacenamiento Persistente)
volumes:
  mysql_data:
    # Volumen para guardar datos de MySQL
    driver: local # Almacena en el disco local de tu PC
  mongo_data:
    # Volumen para guardar datos de MongoDB
    driver: local # Almacena en el disco local de tu PC

# REDES (Comunicación entre Contenedores)
networks:
  siglab_network:
    # Red interna para que los contenedores se comuniquen entre sí
    driver: bridge # Tipo de red: bridge (red virtual privada)
