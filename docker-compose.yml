services:
  # SERVICIO 1: Base de datos MySQL
  mysql:
    image: mysql:8.0 # Imagen oficial MySQL 8.0
    container_name: mysql_siglab # Nombre del contenedor
    restart: always # Reinicio automático
    environment:
      # Variables de entorno MySQL
      MYSQL_ROOT_PASSWORD: Clubpengui1 # Contraseña root
      MYSQL_DATABASE: proyecto_maquinas # Base de datos automática
    ports:
      - "13306:3306" # Mapeo puerto 13306 -> 3306
    volumes:
      - mysql_data:/var/lib/mysql # Persistencia de datos
    networks:
      - siglab_network # Red interna
    healthcheck:
      # Verificación de salud MySQL
      test: [ "CMD-SHELL", "mysqladmin ping -h localhost -u root -pClubpengui1 || exit 1" ]
      interval: 30s # Verificación cada 30s
      timeout: 10s # Timeout 10s
      retries: 5 # 5 reintentos
      start_period: 40s # Periodo de gracia 40s

  # SERVICIO 2: Base de datos MongoDB
  mongodb:
    image: mongo:latest # Imagen oficial MongoDB
    container_name: mongo_siglab # Nombre del contenedor
    restart: always # Reinicio automático
    ports:
      - "27018:27017" # Mapeo puerto 27018 -> 27017
    volumes:
      - mongo_data:/data/db # Persistencia MongoDB
    networks:
      - siglab_network # Red interna
    healthcheck:
      # Verificación de salud MongoDB
      test: [ "CMD-SHELL", "mongosh --eval \"db.adminCommand('ping')\" --quiet || exit 1" ]
      interval: 30s # Verificación cada 30s
      timeout: 10s # Timeout 10s
      retries: 3 # 3 reintentos
      start_period: 15s # Periodo de gracia 15s

  # SERVICIO 3: Backend con Réplicas (FastAPI) - Escalable para máquinas
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    restart: always
    environment:
      MYSQL_HOST: mysql
      MYSQL_USER: root
      MYSQL_PASSWORD: Clubpengui1
      MYSQL_DATABASE: proyecto_maquinas
      MONGO_HOST: mongodb
      MONGO_PORT: 27017
      SERVER_ID: ${HOSTNAME:-backend}  # ID único por contenedor para dashboard
    volumes:
      - ./backend:/app
    depends_on:
      mysql:
        condition: service_healthy
      mongodb:
        condition: service_healthy
    networks:
      - siglab_network
      - frontend_network  # Para comunicación con nginx
    deploy:
      replicas: 3  # 3 réplicas para balanceo de máquinas
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M
    profiles:
      - all  # Perfil completo con todo menos k6

  # SERVICIO 3.1: Backend Único (para desarrollo sin balanceo)
  backend-simple:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: backend_siglab_simple
    restart: always
    environment:
      MYSQL_HOST: mysql
      MYSQL_USER: root
      MYSQL_PASSWORD: Clubpengui1
      MYSQL_DATABASE: proyecto_maquinas
      MONGO_HOST: mongodb
      MONGO_PORT: 27017
      SERVER_ID: 0  # Servidor único
    ports:
      - "18000:8000"  # Backend simple para desarrollo
    volumes:
      - ./backend:/app
    depends_on:
      mysql:
        condition: service_healthy
      mongodb:
        condition: service_healthy
    networks:
      - siglab_network
      - frontend_network  # Red exclusiva para frontend
    profiles:
      - all  # Todo junto

  # SERVICIO 4: Balanceador de Carga Nginx (SOLO para microservicio máquinas)
  nginx:
    build:
      context: ./nginx
      dockerfile: Dockerfile
    container_name: nginx_balancer
    restart: always
    ports:
      - "8888:80"      # Balanceador principal para máquinas (cambiado de 80)
      - "8080:8080"   # Monitoreo de estado
    networks:
      - siglab_network
      - frontend_network  # Para comunicación con frontend
    profiles:
      - all  # Solo en perfil completo

  # SERVICIO 5: Frontend
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: frontend_siglab
    restart: always
    ports:
      - "18080:5173"  # Vite dev server puerto 5173
    volumes:
      # Montar código para desarrollo en caliente
      - ./frontend:/app
      - /app/node_modules  # Evitar sobreescribir node_modules
    depends_on:
      - backend-simple  # Solo backend simple
    networks:
      - frontend_network  # Red exclusiva con backend-simple
    profiles:
      - all  # Todo junto

# SERVICIO 6: Saturador k6 para pruebas de carga
  k6-saturator:
    build:
      context: ./k6
      dockerfile: Dockerfile
    container_name: k6_saturator
    environment:
      BASE_URL: http://nginx_balancer:80  # URL de nginx para máquinas
    networks:
      - siglab_network
      - frontend_network  # Para comunicación con nginx
    profiles:
      - load-test  # Solo k6 (asume que el resto ya corre)

# VOLÚMENES - Almacenamiento Persistente
volumes:
  mysql_data:
    # Volumen datos MySQL
    driver: local # Almacenamiento local
  mongo_data:
    # Volumen datos MongoDB
    driver: local # Almacenamiento local

# REDES - Comunicación entre Contenedores
networks:
  siglab_network:
    # Red interna principal
    driver: bridge # Red virtual privada
  
  frontend_network:
    # Red exclusiva frontend
    driver: bridge
